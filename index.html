<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إعراب ماستر - الجملة الفعلية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Tajawal', 'sans-serif'],
            },
            colors: {
              night: {
                900: '#050b14', // Very dark blue/black
                800: '#0a1628',
                700: '#0f223d',
              },
              neon: {
                blue: '#3b82f6',
                glow: '#60a5fa',
              }
            },
            keyframes: {
              in: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              'fade-in': {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              'slide-in-from-bottom-4': {
                '0%': { transform: 'translateY(1rem)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              },
              'zoom-in-95': {
                '0%': { transform: 'scale(.95)', opacity: '0' },
                '100%': { transform: 'scale(1)', opacity: '1' },
              },
            },
            animation: {
              in: 'in .5s ease-out',
              'fade-in': 'fade-in .5s ease-out',
              'slide-in-from-bottom-4': 'slide-in-from-bottom-4 .5s ease-out',
              'zoom-in-95': 'zoom-in-95 .3s ease-out',
            }
          },
        },
      }
    </script>
    <style>
      body {
        background-color: #020617; /* Slate 950 */
        color: #f8fafc;
      }
      /* Custom scrollbar for dark theme */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #0f172a;
      }
      ::-webkit-scrollbar-thumb {
        background: #1e293b;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #334155;
      }
      /* For animate-in */
      @keyframes in {
        from {
          opacity: 0;
          transform: translateY(1rem);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-in {
        animation: in 0.5s ease-out;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "@google/genai": "https://esm.sh/@google/generative-ai"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script type="module">
      import React from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenerativeAI as GoogleGenAI } from '@google/genai';

      const { useState, useEffect, useRef } = React;
      const e = React.createElement;

      // --- Start of types.ts ---
      const Sender = {
        USER: 'user',
        AI: 'ai'
      };
      const ExerciseStatus = {
        IDLE: 'idle',
        GENERATING: 'generating',
        WAITING_FOR_ANSWER: 'waiting',
        EVALUATING: 'evaluating',
        COMPLETED: 'completed'
      };

      // --- Start of constants.ts ---
      const SYSTEM_INSTRUCTION = `
      You are an expert Arabic Language Tutor (Mudarris) specializing in Grammar (Nahw) and Parsing (I'rab). 
      Your persona is wise, encouraging, and patient. You speak in clear Arabic.

      Your primary focus is teaching the user about "Al-Jumlah Al-Fi'liyyah" (The Verbal Sentence), specifically:
      1. The Verb (Al-Fi'l): Madi (Past), Mudari (Present), Amr (Imperative).
      2. The Doer/Subject (Al-Fa'il).
      3. Briefly mentioning the Object (Maf'ul bihi) if necessary for context.

      When the user asks for an exercise:
      1. Generate a sentence suitable for their level.
      2. Ask them to parse it (I'rab).
      3. When they provide the answer, correct it gently, explaining the grammatical signs (Harakat) and the underlying rule.

      Do not give long lectures unless asked. Keep interactions interactive. 
      If the user speaks English, you can explain in English, but the examples must be in Arabic.
      `;

      const GRAMMAR_TOPICS = [
        {
          title: "تعريف الجملة الفعلية",
          description: "هي الجملة التي تبدأ بفعل، وتتكون أساساً من فعل وفاعل.",
          examples: ["كَتَبَ الطالبُ الدرسَ", "يَزْرَعُ الفلاحُ الحقلَ"]
        },
        {
          title: "الفعل الماضي",
          description: "ما دل على حدث وقع وانقطع قبل زمن التكلم. الأصل فيه البناء (مبني على الفتح، الضم، أو السكون).",
          examples: ["شَرِبَ (مبني على الفتح)", "شَرِبُوا (مبني على الضم)", "شَرِبْتُ (مبني على السكون)"]
        },
        {
          title: "الفعل المضارع",
          description: "ما دل على حدث يقع في زمن التكلم أو بعده. يكون مرفوعاً ما لم يسبقه ناصب أو جازم.",
          examples: ["يَذْهَبُ (مرفوع بالضمة)", "لَن يَذْهَبَ (منصوب)", "لَمْ يَذْهَبْ (مجزوم)"]
        },
        {
          title: "الفاعل",
          description: "هو من قام بالفعل أو اتصف به، ويكون دائماً مرفوعاً.",
          examples: ["جاءَ **الرجلُ** (مرفوع بالضمة)", "نجح **الطالبان** (مرفوع بالألف)", "صلى **المؤمنون** (مرفوع بالواو)"]
        }
      ];

      // --- Start of services/geminiService.ts ---
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      let chatSession = null;

      const getChatSession = () => {
        if (!chatSession) {
          chatSession = ai.chats.create({
            model: 'gemini-2.5-flash',
            config: {
              systemInstruction: SYSTEM_INSTRUCTION,
              temperature: 0.7,
            },
          });
        }
        return chatSession;
      };

      const sendMessageStream = async (message) => {
        const chat = getChatSession();
        return await chat.sendMessageStream({ message });
      };

      const generateExerciseSentence = async (difficulty) => {
        const prompt = `Give me a single Arabic verbal sentence (Jumla Fi'liyyah) for a ${difficulty} level student to parse (I'rab). Return ONLY the sentence in Arabic text. Do not add any explanations or translation.`;
        const response = await ai.models.generateContent({ model: 'gemini-2.5-flash', contents: prompt });
        return response.text.trim();
      };

      const evaluateIrab = async (sentence, userAnalysis) => {
        const prompt = `The sentence is: "${sentence}"\nThe student's parsing (I'rab) is: "${userAnalysis}"\n\nPlease evaluate this parsing. 1. Correct any mistakes. 2. Explain the correct I'rab clearly. 3. Give a short supportive comment.`;
        const response = await ai.models.generateContent({ model: 'gemini-2.5-flash', contents: prompt, config: { systemInstruction: SYSTEM_INSTRUCTION } });
        return response.text;
      };

      // --- Start of components/IconComponents.tsx ---
      const svgProps = { width: 20, height: 20, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" };
      const SendIcon = () => e('svg', { ...svgProps, width: 20, height: 20 }, e('line', { x1: "22", y1: "2", x2: "11", y2: "13" }), e('polygon', { points: "22 2 15 22 11 13 2 9 22 2" }));
      const BookOpenIcon = () => e('svg', { ...svgProps, width: 20, height: 20 }, e('path', { d: "M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" }), e('path', { d: "M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" }));
      const BotIcon = () => e('svg', { ...svgProps, width: 24, height: 24 }, e('rect', { x: "3", y: "11", width: "18", height: "10", rx: "2" }), e('circle', { cx: "12", cy: "5", r: "2" }), e('path', { d: "M12 7v4" }), e('line', { x1: "8", y1: "16", x2: "8", y2: "16" }), e('line', { x1: "16", y1: "16", x2: "16", y2: "16" }));
      const RefreshCwIcon = () => e('svg', { ...svgProps, width: 16, height: 16 }, e('path', { d: "M23 4v6h-6" }), e('path', { d: "M1 20v-6h6" }), e('path', { d: "M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" }));
      const CheckIcon = () => e('svg', { ...svgProps, width: 16, height: 16 }, e('polyline', { points: "20 6 9 17 4 12" }));

      // --- Start of components/GrammarReference.tsx ---
      const GrammarReference = () => {
        return e('div', { className: "bg-night-800 border border-slate-800 rounded-xl p-6 h-full overflow-y-auto shadow-xl" },
          e('div', { className: "flex items-center gap-3 mb-6 border-b border-slate-800 pb-4" },
            e('div', { className: "p-2 bg-blue-900/30 rounded-lg text-blue-400" }, e(BookOpenIcon)),
            e('h2', { className: "text-xl font-bold text-white" }, "قواعد الجملة الفعلية")
          ),
          e('div', { className: "space-y-4" },
            GRAMMAR_TOPICS.map((topic, index) => e('div', { key: index, className: "group" },
              e('h3', { className: "text-lg font-semibold text-blue-400 mb-2 group-hover:text-blue-300 transition-colors" }, topic.title),
              e('p', { className: "text-slate-300 text-sm leading-relaxed mb-3" }, topic.description),
              e('div', { className: "bg-night-900/50 rounded-md p-3 border-r-2 border-blue-600" },
                e('span', { className: "text-xs text-slate-500 block mb-1" }, "أمثلة:"),
                e('ul', { className: "list-disc list-inside text-sm text-slate-400" },
                  topic.examples.map((ex, i) => e('li', { key: i, dangerouslySetInnerHTML: { __html: ex } }))
                )
              )
            ))
          )
        );
      };

      // --- Start of components/ChatTutor.tsx ---
      const ChatTutor = () => {
        const [messages, setMessages] = useState([
          { id: 'welcome', text: 'أهلاً بك يا طالب العلم. أنا معلمك للغة العربية. كيف يمكنني مساعدتك في إعراب الجملة الفعلية اليوم؟', sender: Sender.AI, timestamp: Date.now() }
        ]);
        const [inputValue, setInputValue] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const messagesEndRef = useRef(null);

        const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        useEffect(scrollToBottom, [messages]);

        const handleSend = async () => {
          if (!inputValue.trim() || isLoading) return;
          const userMsg = { id: Date.now().toString(), text: inputValue, sender: Sender.USER, timestamp: Date.now() };
          setMessages(prev => [...prev, userMsg]);
          setInputValue('');
          setIsLoading(true);
          try {
            const streamResult = await sendMessageStream(userMsg.text);
            const aiMsgId = (Date.now() + 1).toString();
            setMessages(prev => [...prev, { id: aiMsgId, text: '', sender: Sender.AI, timestamp: Date.now() }]);
            let accumulatedText = '';
            for await (const chunk of streamResult) {
              const text = chunk.text;
              if (text) {
                accumulatedText += text;
                setMessages(prev => prev.map(msg => msg.id === aiMsgId ? { ...msg, text: accumulatedText } : msg));
              }
            }
          } catch (error) {
            console.error("Error sending message:", error);
            setMessages(prev => [...prev, { id: Date.now().toString(), text: "عذراً، حدث خطأ في الاتصال. حاول مرة أخرى.", sender: Sender.AI, timestamp: Date.now() }]);
          } finally {
            setIsLoading(false);
          }
        };

        const handleKeyDown = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
        };

        return e('div', { className: "flex flex-col h-full bg-night-800 rounded-xl border border-slate-800 shadow-xl overflow-hidden" },
          e('div', { className: "p-4 border-b border-slate-800 bg-night-900 flex items-center gap-3" },
            e('div', { className: "w-10 h-10 rounded-full bg-blue-900 flex items-center justify-center text-blue-300" }, e(BotIcon)),
            e('div', null, e('h3', { className: "font-bold text-white" }, "المعلم الآلي"), e('p', { className: "text-xs text-blue-400" }, "متاح للمساعدة الفورية"))
          ),
          e('div', { className: "flex-1 overflow-y-auto p-4 space-y-4" },
            messages.map(msg => e('div', { key: msg.id, className: `flex ${msg.sender === Sender.USER ? 'justify-start' : 'justify-end'}` },
              e('div', { className: `max-w-[85%] rounded-2xl p-4 text-sm leading-7 ${msg.sender === Sender.USER ? 'bg-blue-700 text-white rounded-br-none' : 'bg-slate-800 text-slate-200 rounded-bl-none border border-slate-700'}` },
                msg.text.split('**').map((part, i) => i % 2 === 1 ? e('strong', { key: i, className: "text-blue-300 font-bold" }, part) : part)
              )
            )),
            isLoading && e('div', { className: "flex justify-end" },
              e('div', { className: "bg-slate-800 rounded-2xl rounded-bl-none p-4 border border-slate-700" },
                e('div', { className: "flex gap-1" },
                  e('span', { className: "w-2 h-2 bg-blue-500 rounded-full animate-bounce" }),
                  e('span', { className: "w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-75" }),
                  e('span', { className: "w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-150" })
                )
              )
            ),
            e('div', { ref: messagesEndRef })
          ),
          e('div', { className: "p-4 bg-night-900 border-t border-slate-800" },
            e('div', { className: "flex gap-2 relative" },
              e('input', { type: "text", value: inputValue, onChange: (e) => setInputValue(e.target.value), onKeyDown: handleKeyDown, placeholder: "اسأل عن إعراب جملة أو قاعدة...", className: "w-full bg-night-800 text-white placeholder-slate-500 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent", disabled: isLoading }),
              e('button', { onClick: handleSend, disabled: isLoading || !inputValue.trim(), className: "absolute left-2 top-2 bottom-2 p-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" }, e(SendIcon))
            )
          )
        );
      };

      // --- Start of components/ExerciseZone.tsx ---
      const ExerciseZone = () => {
        const [status, setStatus] = useState(ExerciseStatus.IDLE);
        const [sentence, setSentence] = useState(null);
        const [userAnalysis, setUserAnalysis] = useState('');
        const [feedback, setFeedback] = useState(null);
        const [difficulty, setDifficulty] = useState('easy');

        const handleGenerate = async () => {
          setStatus(ExerciseStatus.GENERATING);
          setFeedback(null);
          setUserAnalysis('');
          try {
            const newSentence = await generateExerciseSentence(difficulty);
            setSentence(newSentence);
            setStatus(ExerciseStatus.WAITING_FOR_ANSWER);
          } catch (e) { console.error(e); setStatus(ExerciseStatus.IDLE); }
        };

        const handleSubmit = async () => {
          if (!sentence || !userAnalysis.trim()) return;
          setStatus(ExerciseStatus.EVALUATING);
          try {
            const result = await evaluateIrab(sentence, userAnalysis);
            setFeedback(result);
            setStatus(ExerciseStatus.COMPLETED);
          } catch (e) { console.error(e); setStatus(ExerciseStatus.WAITING_FOR_ANSWER); }
        };

        return e('div', { className: "bg-gradient-to-br from-blue-950/40 to-night-900 border border-slate-700/50 rounded-xl p-6 shadow-xl relative overflow-hidden" },
          e('div', { className: "absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 to-purple-600" }),
          e('h2', { className: "text-2xl font-bold text-white mb-6" }, "ساحة التدريب"),
          e('div', { className: "flex gap-4 mb-6" },
            ['easy', 'medium', 'hard'].map(lvl => e('button', { key: lvl, onClick: () => setDifficulty(lvl), className: `px-4 py-1.5 rounded-full text-sm font-medium transition-all ${difficulty === lvl ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}` }, lvl === 'easy' ? 'مبتدئ' : lvl === 'medium' ? 'متوسط' : 'متقدم'))
          ),
          e('div', { className: "space-y-6" },
            !sentence ? e('div', { className: "text-center py-10 bg-slate-900/50 rounded-xl border border-dashed border-slate-700" },
              e('p', { className: "text-slate-400 mb-4" }, "اضغط على الزر للحصول على جملة فعلية جديدة"),
              e('button', { onClick: handleGenerate, disabled: status === ExerciseStatus.GENERATING, className: "inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-bold transition-all disabled:opacity-50" }, status === ExerciseStatus.GENERATING ? 'جاري التحضير...' : 'توليد جملة جديدة', !status.includes('generating') && e(RefreshCwIcon))
            ) : e('div', { className: "space-y-6 animate-in" },
              e('div', { className: "bg-black/30 p-6 rounded-xl border border-blue-900/50 text-center" },
                e('span', { className: "text-sm text-blue-400 block mb-2" }, "أعرب الجملة التالية:"),
                e('h3', { className: "text-3xl font-bold text-white font-serif" }, sentence)
              ),
              e('div', { className: "space-y-3" },
                e('label', { className: "text-slate-300 text-sm" }, "اكتب الإعراب هنا:"),
                e('textarea', { value: userAnalysis, onChange: (e) => setUserAnalysis(e.target.value), placeholder: "مثال: شرب: فعل ماض...، الطفل: فاعل...", disabled: status === ExerciseStatus.COMPLETED || status === ExerciseStatus.EVALUATING, className: "w-full h-32 bg-night-800 text-white border border-slate-700 rounded-lg p-4 focus:ring-2 focus:ring-blue-600 focus:border-transparent focus:outline-none resize-none" })
              ),
              status !== ExerciseStatus.COMPLETED && e('div', { className: "flex gap-3" },
                e('button', { onClick: handleSubmit, disabled: !userAnalysis.trim() || status === ExerciseStatus.EVALUATING, className: "flex-1 bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded-lg font-bold transition-all disabled:opacity-50 flex justify-center items-center gap-2" }, status === ExerciseStatus.EVALUATING ? 'جاري التصحيح...' : 'تحقق من الإجابة', status !== ExerciseStatus.EVALUATING && e(CheckIcon)),
                e('button', { onClick: handleGenerate, className: "px-4 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors" }, e(RefreshCwIcon))
              ),
              feedback && e('div', { className: "bg-night-900/80 border border-green-900/50 p-6 rounded-xl mt-4 animate-in" },
                e('h4', { className: "text-green-400 font-bold mb-3 flex items-center gap-2" }, e(CheckIcon), " التقييم"),
                e('div', { className: "prose prose-invert prose-sm max-w-none text-slate-300 leading-relaxed whitespace-pre-wrap" }, feedback),
                e('button', { onClick: handleGenerate, className: "mt-6 w-full bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-bold transition-all" }, "جملة جديدة")
              )
            )
          )
        );
      };

      // --- Start of App.tsx ---
      const App = () => {
        return e('div', { className: "min-h-screen bg-night-900 text-slate-100 font-sans selection:bg-blue-500/30" },
          e('nav', { className: "border-b border-slate-800 bg-night-900/80 backdrop-blur-md sticky top-0 z-50" },
            e('div', { className: "container mx-auto px-4 h-16 flex items-center justify-between" },
              e('div', { className: "flex items-center gap-3" },
                e('div', { className: "w-8 h-8 rounded-lg bg-gradient-to-tr from-blue-600 to-cyan-400 flex items-center justify-center" },
                  e('span', { className: "text-white font-bold text-lg" }, "ع")
                ),
                e('h1', { className: "text-xl font-bold tracking-tight text-white" }, "إعراب ", e('span', { className: "text-blue-400" }, "ماستر"))
              ),
              e('div', { className: "flex items-center gap-4" },
                e('div', { className: "text-sm text-slate-400 font-medium hidden md:block" }, "الجملة الفعلية"),
                e('div', { className: "hidden md:block border-r border-slate-700 h-5" }),
                e('div', { className: "text-sm text-slate-200 font-semibold hidden md:block" }, "نهاد مصري")
              )
            )
          ),
          e('main', { className: "container mx-auto px-4 py-6 h-[calc(100vh-4rem)]" },
            e('div', { className: "grid grid-cols-1 lg:grid-cols-12 gap-6 h-full" },
              e('div', { className: "lg:col-span-7 flex flex-col gap-6 h-full overflow-y-auto pr-1" },
                e('div', { className: "shrink-0" }, e(ExerciseZone)),
                e('div', { className: "flex-1 min-h-[300px]" }, e(GrammarReference))
              ),
              e('div', { className: "lg:col-span-5 h-[500px] lg:h-full" }, e(ChatTutor))
            )
          )
        );
      };

      // --- Start of index.tsx ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }
      const root = ReactDOM.createRoot(rootElement);
      root.render(e(React.StrictMode, null, e(App)));

    </script>
  </body>
</html>